name: Clang

on:
  push:
    branches:
      - '**'

jobs:
  momo-test:
    strategy:
      matrix:
        include:

        # x64
        - clang_ver: '18'
          ubuntu_ver: '24.04'
          build_type: 'Release'
          no_exceptions_rtti: 'Off'
          extra_settings: 'Off'
          flags: '-std=c++23 -Werror'

        - clang_ver: '18'
          ubuntu_ver: '24.04'
          build_type: 'Release'
          no_exceptions_rtti: 'Off'
          extra_settings: 'Off'
          flags: '-std=c++26 -Werror'

        - clang_ver: '18'
          ubuntu_ver: '24.04'
          build_type: 'Debug'
          no_exceptions_rtti: 'Off'
          extra_settings: 'Off'
          flags: '-std=c++26 -Werror -fsanitize=address,undefined'

        - clang_ver: '18'
          ubuntu_ver: '24.04'
          build_type: 'Release'
          no_exceptions_rtti: 'On'
          extra_settings: 'Off'
          flags: '-std=c++26 -Werror'

        - clang_ver: '18'
          ubuntu_ver: '24.04'
          build_type: 'Release'
          no_exceptions_rtti: 'Off'
          extra_settings: 'On'
          flags: '-std=c++26 -Werror'

        # ARM64
        - clang_ver: '18'
          ubuntu_ver: '24.04-arm'
          build_type: 'Release'
          no_exceptions_rtti: 'Off'
          extra_settings: 'Off'
          flags: '-std=c++23 -Werror'

        - clang_ver: '18'
          ubuntu_ver: '24.04-arm'
          build_type: 'Release'
          no_exceptions_rtti: 'Off'
          extra_settings: 'Off'
          flags: '-std=c++26 -Werror'

        - clang_ver: '18'
          ubuntu_ver: '24.04-arm'
          build_type: 'Debug'
          no_exceptions_rtti: 'Off'
          extra_settings: 'Off'
          flags: '-std=c++26 -Werror -fsanitize=address,undefined'

        - clang_ver: '18'
          ubuntu_ver: '24.04-arm'
          build_type: 'Release'
          no_exceptions_rtti: 'On'
          extra_settings: 'Off'
          flags: '-std=c++26 -Werror'

        - clang_ver: '18'
          ubuntu_ver: '24.04-arm'
          build_type: 'Release'
          no_exceptions_rtti: 'Off'
          extra_settings: 'On'
          flags: '-std=c++26 -Werror'

    runs-on: ubuntu-${{ matrix.ubuntu_ver }}

    steps:
#    - name: Increase swapfile
#      run: |
#        sudo swapoff -a
#        sudo fallocate -l 15G /swapfile
#        sudo chmod 600 /swapfile
#        sudo mkswap /swapfile
#        sudo swapon /swapfile
#        sudo swapon --show
    - name: Checkout
      uses: actions/checkout@v4
#    - name: Install Ninja
#      run: sudo apt install ninja-build
    - name: Install Clang
      run: sudo apt install clang-${{ matrix.clang_ver }}
    - name: Build
      env:
        CXX: clang++-${{ matrix.clang_ver }}
        CXXFLAGS: ${{ matrix.flags }}
      run: |
        cd test
        mkdir build
        cd build
        cmake .. -G Ninja -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
          -DMOMO_TEST_NO_EXCEPTIONS_RTTI=${{ matrix.no_exceptions_rtti }} \
          -DMOMO_TEST_EXTRA_SETTINGS=${{ matrix.extra_settings }}
        cmake --build . -v
    - name: Test
      run: test/build/momo_test
